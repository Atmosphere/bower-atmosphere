/*
 * Copyright 2014 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * Atmosphere.js
 * https://github.com/Atmosphere/atmosphere-javascript
 * 
 * API reference
 * https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API
 * 
 * Highly inspired by 
 * - Portal by Donghwan Kim http://flowersinthesand.github.io/portal/
 */
(function(d,q){"function"===typeof define&&define.amd?define(q):d.atmosphere=q()})(this,function(){var d={},q=[],E=[],V=0,Y=Object.prototype.hasOwnProperty,d={onError:function(d){},onClose:function(d){},onOpen:function(d){},onReopen:function(d){},onMessage:function(d){},onReconnect:function(d,g){},onMessagePublished:function(d){},onTransportFailure:function(d,g){},onLocalMessage:function(d){},onFailureToReconnect:function(d,g){},onClientTimeout:function(d){},WebsocketApiAdapter:function(f){var g,
l;f.onMessage=function(d){l.onmessage({data:d.responseBody})};f.onOpen=function(d){l.onopen(d)};l={send:function(d){g.push(d)},onmessage:function(d){},onopen:function(d){},onclose:function(d){},onerror:function(d){}};g=new d.subscribe(f);return l},AtmosphereRequest:function(f){function g(b,a){return""===e.partialMessage&&"streaming"===a.transport&&b.responseText.length>a.maxStreamingLength?!0:!1}function l(){if(c.enableProtocol&&!c.firstMessage){var b="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+
c.uuid;d.util.each(c.headers,function(a,h){var f=d.util.isFunction(h)?h.call(this,c,c,e):h;null!=f&&(b+="&"+encodeURIComponent(a)+"="+encodeURIComponent(f))});var a=c.url.replace(/([?&])_=[^&]*/,b),a=a+(a===c.url?(/\?/.test(c.url)?"&":"?")+b:""),h=new d.AtmosphereRequest({connected:!1});h.attachHeadersAsQueryString=!1;h.dropHeaders=!0;h.url=a;h.contentType="text/plain";h.transport="polling";h.method="GET";h.data="";h.async=!1;na("",h)}}function k(){"debug"===c.logLevel&&d.util.debug("Closing");F=
!0;c.reconnectId&&(clearTimeout(c.reconnectId),delete c.reconnectId);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer);c.reconnect=!1;e.request=c;e.state="unsubscribe";e.responseBody="";e.status=408;e.partialMessage="";w();l();m()}function m(){e.partialMessage="";c.id&&clearTimeout(c.id);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer);null!=B&&(B.close(),B=null);null!=C&&(C.abort(),C=null);null!=K&&(K.abort(),K=null);null!=r&&(r.canSendMessage&&r.close(),r=null);null!=x&&(x.close(),x=null);null!=
D&&(clearInterval(W),document.cookie=Z+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",D.signal("close",{reason:"",heir:F?(D.get("children")||[])[0]:y}),D.close());null!=u&&u.close()}function ea(b){m();$=!0;F=!1;z=0;B=K=x=r=null;c=d.util.extend(c,b);c.mrequest=c.reconnect;c.reconnect||(c.reconnect=!0)}function A(){if(c.shared){u=q(c);if(null!=u&&("debug"===c.logLevel&&d.util.debug("Storage service available. All communication will be local"),u.open(c)))return;"debug"===c.logLevel&&d.util.debug("No Storage service available.");
u=null}c.firstMessage=0==V?!0:!1;c.isOpen=!1;c.ctime=d.util.now();0===c.uuid&&(c.uuid=V);e.closedByClientTimeout=!1;"websocket"!==c.transport&&"sse"!==c.transport?O(c):"websocket"===c.transport?null!=c.webSocketImpl||window.WebSocket||window.MozWebSocket?aa(!1):L("Websocket is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"):"sse"===c.transport&&(window.EventSource?p(!1):L("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"))}
function q(b){function a(a,b){var c,d=a.length;for(c=0;c<d;c++)a[c]===b&&a.splice(c,1);return d!==a.length}function h(a){a=d.util.parseJSON(a);var h=a.data;if("c"===a.target)switch(a.type){case "open":s("opening","local",c);break;case "close":ba||(ba=!0,"aborted"===h.reason?k():h.heir===y?A():setTimeout(function(){A()},100));break;case "message":M(h,"messageReceived",200,b.transport);break;case "localMessage":fa(h)}}function e(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(t)+")=([^;]*)")).exec(document.cookie);
if(a)return d.util.parseJSON(decodeURIComponent(a[2]))}var f,J,ba,t="atmosphere-"+b.url,g={storage:function(){function c(a){a.key===t&&a.newValue&&h(a.newValue)}if(d.util.storage){var e=window.localStorage,n=function(a){return d.util.parseJSON(e.getItem(t+"-"+a))};return{init:function(){var a=n("children").concat([y]);e.setItem(t+"-children",d.util.stringifyJSON(a));d.util.on(window,"storage",c);return n("opened")},signal:function(a,b){e.setItem(t,d.util.stringifyJSON({target:"p",type:a,data:b}))},
close:function(){var h=n("children");d.util.off(window,"storage",c);h&&a(h,b.id)&&e.setItem(t+"-children",d.util.stringifyJSON(h))}}}},windowref:function(){var b=window.open("",t.replace(/\W/g,""));if(b&&!b.closed&&b.callbacks)return{init:function(){b.callbacks.push(h);b.children.push(y);return b.opened},signal:function(a,c){!b.closed&&b.fire&&b.fire(d.util.stringifyJSON({target:"p",type:a,data:c}))},close:function(){ba||(a(b.callbacks,h),a(b.children,y))}}}};if((f=e())&&!(1E3<d.util.now()-f.ts)&&
(J=g.storage()||g.windowref()))return{open:function(){var a;W=setInterval(function(){var a=f;(f=e())&&a.ts!==f.ts||h(d.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:a.heir}}))},1E3);(a=J.init())&&setTimeout(function(){s("opening","local",b)},50);return a},send:function(a){J.signal("send",a)},localSend:function(a){J.signal("localSend",d.util.stringifyJSON({id:y,event:a}))},close:function(){F||(clearInterval(W),J.signal("close"),J.close())}}}function oa(){function b(a){a=d.util.parseJSON(a);
var b=a.data;if("p"===a.target)switch(a.type){case "send":P(b);break;case "localSend":fa(b);break;case "close":k()}}function a(){document.cookie=Z+"="+encodeURIComponent(d.util.stringifyJSON({ts:d.util.now()+1,heir:(h.get("children")||[])[0]}))+"; path=/"}var h,e="atmosphere-"+c.url,f={storage:function(){function a(c){c.key===e&&c.newValue&&b(c.newValue)}if(d.util.storage){var c=window.localStorage;return{init:function(){d.util.on(window,"storage",a)},signal:function(a,b){c.setItem(e,d.util.stringifyJSON({target:"c",
type:a,data:b}))},get:function(a){return d.util.parseJSON(c.getItem(e+"-"+a))},set:function(a,b){c.setItem(e+"-"+a,d.util.stringifyJSON(b))},close:function(){d.util.off(window,"storage",a);c.removeItem(e);c.removeItem(e+"-opened");c.removeItem(e+"-children")}}}},windowref:function(){var a=e.replace(/\W/g,""),c=document.getElementById(a),h;c||(c=document.createElement("div"),c.id=a,c.style.display="none",c.innerHTML='<iframe name="'+a+'" />',document.body.appendChild(c));h=c.firstChild.contentWindow;
return{init:function(){h.callbacks=[b];h.fire=function(a){var b;for(b=0;b<h.callbacks.length;b++)h.callbacks[b](a)}},signal:function(a,b){!h.closed&&h.fire&&h.fire(d.util.stringifyJSON({target:"c",type:a,data:b}))},get:function(a){return h.closed?null:h[a]},set:function(a,b){h.closed||(h[a]=b)},close:function(){}}}};Q=function(a){h.signal("message",a)};h=f.storage()||f.windowref();h.init();"debug"===c.logLevel&&d.util.debug("Installed StorageService "+h);h.set("children",[]);null==h.get("opened")||
h.get("opened")||h.set("opened",!1);Z=encodeURIComponent(e);a();W=setInterval(a,1E3);D=h}function s(b,a,h){c.shared&&"local"!==a&&oa();null!=D&&D.set("opened",!0);h.close=function(){k()};0<z&&"re-connecting"===b?(h.isReopen=!0,pa(e)):null==e.error&&(e.request=h,h=e.state,e.state=b,b=e.transport,e.transport=a,a=e.responseBody,w(),e.responseBody=a,e.state=h,e.transport=b)}function ga(b){b.transport="jsonp";var a=c,h;null!=b&&"undefined"!==typeof b&&(a=b);C={open:function(){function f(){var c=a.url;
null!=a.dispatchUrl&&(c+=a.dispatchUrl);var d=a.data;a.attachHeadersAsQueryString&&(c=N(a),""!==d&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(d)),d="");d=document.head||document.getElementsByTagName("head")[0]||document.documentElement;h=document.createElement("script");h.src=c+"&jsonpTransport="+g;h.clean=function(){h.clean=h.onerror=h.onload=h.onreadystatechange=null;h.parentNode&&h.parentNode.removeChild(h)};h.onload=h.onreadystatechange=function(){h.readyState&&!/loaded|complete/.test(h.readyState)||
h.clean()};h.onerror=function(){h.clean();a.lastIndex=0;a.openId&&clearTimeout(a.openId);a.heartbeatTimer&&clearTimeout(a.heartbeatTimer);a.reconnect&&z++<a.maxReconnectOnClose?(s("re-connecting",a.transport,a),I(C,a,b.reconnectInterval),a.openId=setTimeout(function(){R(a)},a.reconnectInterval+1E3)):v(0,"maxReconnectOnClose reached")};d.insertBefore(h,d.firstChild)}var g="atmosphere"+ ++y;window[g]=function(b){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<a.maxRequest){a.executeCallbackBeforeReconnect||
I(C,a,a.pollingInterval);if(null!=b&&"string"!==typeof b)try{b=b.message}catch(h){}G(b,a,e)||M(e.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&I(C,a,a.pollingInterval)}else d.util.log(c.logLevel,["JSONP reconnect maximum try reached "+c.requestCount]),v(0,"maxRequest reached")};setTimeout(function(){f()},50)},abort:function(){h&&h.clean&&h.clean()}};C.open()}function qa(b){return null!=c.webSocketImpl?c.webSocketImpl:window.WebSocket?new WebSocket(b):new MozWebSocket(b)}
function p(b){e.transport="sse";var a=N(c);"debug"===c.logLevel&&(d.util.debug("Invoking executeSSE"),d.util.debug("Using URL: "+a));if(c.enableProtocol&&b){var h=d.util.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(h)}if(b&&!c.reconnect)null!=x&&m();else{try{x=new EventSource(a,{withCredentials:c.withCredentials})}catch(f){v(0,f);L("SSE failed. Downgrading to fallback transport and resending");return}0<c.connectTimeout&&(c.id=setTimeout(function(){b||m()},c.connectTimeout));x.onopen=function(a){H(c);
"debug"===c.logLevel&&d.util.debug("SSE successfully opened");c.enableProtocol?c.isReopen&&(c.isReopen=!1,s("re-opening",c.transport,c)):b?s("re-opening","sse",c):s("opening","sse",c);b=!0;"POST"===c.method&&(e.state="messageReceived",x.send(c.data))};x.onmessage=function(a){H(c);!c.enableXDR&&a.origin&&a.origin!==window.location.protocol+"//"+window.location.host?d.util.log(c.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(e.state="messageReceived",e.status=200,
a=a.data,G(a,c,e)||(w(),e.responseBody="",e.messages=[]))};x.onerror=function(a){clearTimeout(c.id);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer);e.closedByClientTimeout||((S(b),m(),F)?d.util.log(c.logLevel,["SSE closed normally"]):b?c.reconnect&&"sse"===e.transport&&(z++<c.maxReconnectOnClose?(s("re-connecting",c.transport,c),0<c.reconnectInterval?c.reconnectId=setTimeout(function(){p(!0)},c.reconnectInterval):p(!0),e.responseBody="",e.messages=[]):(d.util.log(c.logLevel,["SSE reconnect maximum try reached "+
z]),v(0,"maxReconnectOnClose reached"))):L("SSE failed. Downgrading to fallback transport and resending"))}}}function aa(b){e.transport="websocket";if(c.enableProtocol&&b){var a=d.util.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(a)}a=N(c,d.util.getAbsoluteURL(c.webSocketUrl||c.url)).replace(/^http/,"ws");"debug"===c.logLevel&&(d.util.debug("Invoking executeWebSocket"),d.util.debug("Using URL: "+a));if(b&&!c.reconnect)null!=r&&m();else if(r=qa(a),null!=c.webSocketBinaryType&&(r.binaryType=
c.webSocketBinaryType),0<c.connectTimeout&&(c.id=setTimeout(function(){if(!b){r.onclose({code:1002,reason:"",wasClean:!1});try{m()}catch(a){}}},c.connectTimeout)),r.onopen=function(a){H(c);"debug"===c.logLevel&&d.util.debug("Websocket successfully opened");a=b;null!=r&&(r.canSendMessage=!0);c.enableProtocol||(b=!0,a?s("re-opening","websocket",c):s("opening","websocket",c));null!=r&&"POST"===c.method&&(e.state="messageReceived",r.send(c.data))},r.onmessage=function(a){H(c);c.enableProtocol&&(b=!0);
e.state="messageReceived";e.status=200;a=a.data;"string"===typeof a?G(a,c,e)||(w(),e.responseBody="",e.messages=[]):(a=ha(c,a),""!==a&&(e.responseBody=a,w(),e.responseBody=null))},r.onerror=function(a){clearTimeout(c.id);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer)},r.onclose=function(a){clearTimeout(c.id);if("closed"!==e.state){var f=a.reason;if(""===f)switch(a.code){case 1E3:f="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:f=
"The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:f="The endpoint is terminating the connection due to a protocol error.";break;case 1003:f="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:f="The endpoint is terminating the connection because a data frame was received that is too large.";
break;case 1005:f="Unknown: no status code was provided even though one was expected.";break;case 1006:f="Connection was closed abnormally (that is, with no close frame being sent)."}"warn"===c.logLevel&&(d.util.warn("Websocket closed, reason: "+f),d.util.warn("Websocket closed, wasClean: "+a.wasClean));e.closedByClientTimeout||((S(b),e.state="closed",F)?d.util.log(c.logLevel,["Websocket closed normally"]):b?c.reconnect&&"websocket"===e.transport&&1001!==a.code&&(m(),z++<c.maxReconnectOnClose?(s("re-connecting",
c.transport,c),0<c.reconnectInterval?c.reconnectId=setTimeout(function(){e.responseBody="";e.messages=[];aa(!0)},c.reconnectInterval):(e.responseBody="",e.messages=[],aa(!0))):(d.util.log(c.logLevel,["Websocket reconnect maximum try reached "+c.requestCount]),"warn"===c.logLevel&&d.util.warn("Websocket error, reason: "+a.reason),v(0,"maxReconnectOnClose reached"))):L("Websocket failed. Downgrading to Comet and resending"))}},-1<navigator.userAgent.toLowerCase().indexOf("android")&&void 0===r.url)r.onclose({reason:"Android 4.1 does not support websockets.",
wasClean:!1})}function ha(b,a){var h=a;if("polling"===b.transport)return h;if(0!==d.util.trim(a).length&&b.enableProtocol&&b.firstMessage){var e=b.trackMessageLength?1:0,f=a.split(b.messageDelimiter);if(f.length<=e+1)return h;b.firstMessage=!1;b.uuid=d.util.trim(f[e]);b.stime=d.util.trim(f[e+1]);f.length<=e+3&&d.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]);
var g=parseInt(d.util.trim(f[e+2]),10),l=f[e+3];if(!isNaN(g)&&0<g){var k=function(){P(l);b.heartbeatTimer=setTimeout(k,g)};b.heartbeatTimer=setTimeout(k,g)}"long-polling"!==b.transport&&R(b);V=b.uuid;h="";e=b.trackMessageLength?5:4;if(f.length>e+1)for(;e<f.length;e++)h+=f[e],e+1!==f.length&&(h+=b.messageDelimiter);0!==b.ackInterval&&setTimeout(function(){P("...ACK...")},b.ackInterval)}else b.enableProtocol&&b.firstMessage&&d.util.browser.msie&&10>+d.util.browser.version.split(".")[0]?d.util.log(c.logLevel,
["Receiving unexpected data from IE"]):R(b);return h}function H(b){clearTimeout(b.id);0<b.timeout&&"polling"!==b.transport&&(b.id=setTimeout(function(){e.closedByClientTimeout=!0;e.state="closedByClient";e.responseBody="";e.status=408;e.messages=[];w();l();m()},b.timeout))}function v(b,a){m();clearTimeout(c.id);e.state="error";e.reasonPhrase=a;e.responseBody="";e.status=b;e.messages=[];w()}function G(b,a,c){b=ha(a,b);if(0===b.length)return!0;c.responseBody=b;if(a.trackMessageLength){b=c.partialMessage+
b;for(var d=[],e=b.indexOf(a.messageDelimiter);-1!==e;){var f=b.substring(0,e),g=+f;if(isNaN(g))throw Error('message length "'+f+'" is not a number');e+=a.messageDelimiter.length;e+g>b.length?e=-1:(d.push(b.substring(e,e+g)),b=b.substring(e+g,b.length),e=b.indexOf(a.messageDelimiter))}c.partialMessage=b;if(0!==d.length)c.responseBody=d.join(a.messageDelimiter),c.messages=d;else return c.responseBody="",c.messages=[],!0}else c.responseBody=b;return!1}function L(b){d.util.log(c.logLevel,[b]);if("undefined"!==
typeof c.onTransportFailure)c.onTransportFailure(b,c);else if("undefined"!==typeof d.util.onTransportFailure)d.util.onTransportFailure(b,c);c.transport=c.fallbackTransport;b=-1===c.connectTimeout?0:c.connectTimeout;c.reconnect&&"none"!==c.transport||null==c.transport?(c.method=c.fallbackMethod,e.transport=c.fallbackTransport,c.fallbackTransport="none",0<b?c.reconnectId=setTimeout(function(){A()},b):A()):v(500,"Unable to reconnect with fallback transport")}function N(b,a){var h=c;null!=b&&"undefined"!==
typeof b&&(h=b);null==a&&(a=h.url);if(!h.attachHeadersAsQueryString||-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+h.uuid;a+="&X-Atmosphere-Framework=2.2.1-javascript";a+="&X-Atmosphere-Transport="+h.transport;h.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");a=null!=h.lastTimestamp?a+("&X-Cache-Date="+h.lastTimestamp):a+"&X-Cache-Date=0";null!==h.heartbeat&&null!==h.heartbeat.server&&(a+="&X-Heartbeat-Server="+h.heartbeat.server);
""!==h.contentType&&(a+="&Content-Type="+("websocket"===h.transport?h.contentType:encodeURIComponent(h.contentType)));h.enableProtocol&&(a+="&X-atmo-protocol=true");d.util.each(h.headers,function(c,f){var g=d.util.isFunction(f)?f.call(this,h,b,e):f;null!=g&&(a+="&"+encodeURIComponent(c)+"="+encodeURIComponent(g))});return a}function R(b){b.isOpen?b.isReopen&&(b.isReopen=!1,s("re-opening",b.transport,b)):(b.isOpen=!0,s("opening",b.transport,b))}function O(b){var a=c;if(null!=b||"undefined"!==typeof b)a=
b;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport||a.enableXDR&&d.util.checkCORSSupport())ga(a);else{if(d.util.browser.msie&&10>+d.util.browser.version.split(".")[0]){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?T(a):U(a);return}if(a.enableXDR&&window.XDomainRequest){T(a);return}}var f=function(){a.lastIndex=0;a.reconnect&&z++<a.maxReconnectOnClose?(s("re-connecting",b.transport,b),I(n,a,b.reconnectInterval)):v(0,"maxReconnectOnClose reached")};if(a.force||a.reconnect&&(-1===
a.maxRequest||a.requestCount++<a.maxRequest)){a.force=!1;var n=d.util.xhr();n.hasData=!1;Y(n,a,!0);a.suspend&&(K=n);"polling"!==a.transport&&(e.transport=a.transport,n.onabort=function(){S(!0)},n.onerror=function(){e.error=!0;e.ffTryingReconnect=!0;try{e.status=XMLHttpRequest.status}catch(a){e.status=500}e.status||(e.status=500);e.errorHandled||(m(),f())});n.onreadystatechange=function(){if(!F){e.error=null;var l=!1,k=!1;if("streaming"===a.transport&&2<a.readyState&&4===n.readyState)m(),f();else{a.readyState=
n.readyState;"streaming"===a.transport&&3<=n.readyState?k=!0:"long-polling"===a.transport&&4===n.readyState&&(k=!0);H(c);if("polling"!==a.transport){var t=200;4===n.readyState&&(t=1E3<n.status?0:n.status);if(300<=t||0===t){e.errorHandled=!0;m();f();return}a.enableProtocol&&b.firstMessage||2!==n.readyState||(d.util.browser.mozilla&&e.ffTryingReconnect?(e.ffTryingReconnect=!1,setTimeout(function(){e.ffTryingReconnect||R(a)},500)):R(a))}else 4===n.readyState&&(k=!0);if(k)if(k=n.responseText,e.errorHandled=
!1,0===d.util.trim(k).length&&"long-polling"===a.transport)n.hasData?n.hasData=!1:(e.errorHandled=!0,m(),f());else{n.hasData=!0;ca(n,c);if("streaming"===a.transport)if(d.util.browser.opera)d.util.iterate(function(){if(500!==e.status&&n.responseText.length>a.lastIndex){try{e.status=n.status,e.headers=d.util.parseHeaders(n.getAllResponseHeaders()),ca(n,c)}catch(b){e.status=404}H(c);e.state="messageReceived";var f=n.responseText.substring(a.lastIndex);a.lastIndex=n.responseText.length;(l=G(f,a,e))||
w();g(n,a)&&ia(n,a)}else if(400<e.status)return a.lastIndex=n.responseText.length,!1},0);else{if(t=k.substring(a.lastIndex,k.length),l=G(t,a,e),a.lastIndex=k.length,l)return}else l=G(k,a,e);k=g(n,a);try{e.status=n.status,e.headers=d.util.parseHeaders(n.getAllResponseHeaders()),ca(n,a)}catch(s){e.status=404}e.state=a.suspend?0===e.status?"closed":"messageReceived":"messagePublished";(t=!k&&"streaming"!==b.transport&&"polling"!==b.transport)&&!a.executeCallbackBeforeReconnect&&I(n,a,a.pollingInterval);
0===e.responseBody.length||l||w();t&&a.executeCallbackBeforeReconnect&&I(n,a,a.pollingInterval);k&&ia(n,a)}}}};try{n.send(a.data),$=!0}catch(l){d.util.log(a.logLevel,["Unable to connect to "+a.url]),v(0,l)}}else"debug"===a.logLevel&&d.util.log(a.logLevel,["Max re-connection reached."]),v(0,"maxRequest reached")}}function ia(b,a){k();F=!1;I(b,a,500)}function Y(b,a,f){var g=a.url;null!=a.dispatchUrl&&"POST"===a.method&&(g+=a.dispatchUrl);g=N(a,g);g=d.util.prepareURL(g);f&&(b.open(a.method,g,a.async),
0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(m(),M("Connect timeout","closed",200,a.transport))},a.connectTimeout)));c.withCredentials&&"websocket"!==c.transport&&"withCredentials"in b&&(b.withCredentials=!0);c.dropHeaders||(b.setRequestHeader("X-Atmosphere-Framework",d.util.version),b.setRequestHeader("X-Atmosphere-Transport",a.transport),null!=a.lastTimestamp?b.setRequestHeader("X-Cache-Date",a.lastTimestamp):b.setRequestHeader("X-Cache-Date",0),null!==b.heartbeat&&null!==
b.heartbeat.server&&b.setRequestHeader("X-Heartbeat-Server",b.heartbeat.server),a.trackMessageLength&&b.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),b.setRequestHeader("X-Atmosphere-tracking-id",a.uuid),d.util.each(a.headers,function(c,g){var l=d.util.isFunction(g)?g.call(this,b,a,f,e):g;null!=l&&b.setRequestHeader(c,l)}));""!==a.contentType&&b.setRequestHeader("Content-Type",a.contentType)}function I(b,a,d){if(a.reconnect||a.suspend&&$){var f=0;b&&1<b.readyState&&(f=1E3<b.status?0:b.status);
e.status=0===f?204:f;e.reason=0===f?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.reconnectId&&(clearTimeout(a.reconnectId),delete a.reconnectId);0<d?c.reconnectId=setTimeout(function(){O(a)},d):O(a)}}function pa(b){b.state="re-connecting";ja(b)}function T(b){"polling"!==b.transport?(B=ka(b),B.open()):ka(b).open()}function ka(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var f=a.transport,g=0,l=new window.XDomainRequest,k=function(){"long-polling"===a.transport&&a.reconnect&&
(-1===a.maxRequest||a.requestCount++<a.maxRequest)&&(l.status=200,T(a))},p=a.rewriteURL||function(a){var b=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(b&&b[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b[2]+"&").replace(/&$/,"")}return a};l.onprogress=function(){clearTimeout(a.id);var b=l.responseText,b=b.substring(g);g+=b.length;if("polling"!==f){H(a);
var c=G(b,a,e);if("long-polling"!==f||0!==d.util.trim(b).length)a.executeCallbackBeforeReconnect&&k(),c||M(e.responseBody,"messageReceived",200,f),a.executeCallbackBeforeReconnect||k()}};l.onerror=function(){"polling"!==a.transport&&(m(),z++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){s("re-connecting",b.transport,b);T(a)},a.reconnectInterval):(s("re-connecting",b.transport,b),T(a)):v(0,"maxReconnectOnClose reached"))};l.onload=function(){};return{open:function(){var b=
a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);b=N(a,b);l.open(a.method,p(b));"GET"===a.method?l.send():l.send(a.data);0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(m(),M("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){l.abort()}}}function U(b){B=ra(b);B.open()}function ra(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var f,g=new window.ActiveXObject("htmlfile");g.open();g.close();var l=a.url;null!=a.dispatchUrl&&(l+=a.dispatchUrl);"polling"!==
a.transport&&(e.transport=a.transport);return{open:function(){var b=g.createElement("iframe");l=N(a);""!==a.data&&(l+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));l=d.util.prepareURL(l);b.src=l;g.body.appendChild(b);var k=b.contentDocument||b.contentWindow.document;f=d.util.iterate(function(){try{if(k.firstChild){var b=k.body?k.body.lastChild:k,l=function(){var a=b.cloneNode(!0);a.appendChild(k.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!k.body||!k.body.firstChild||
"pre"!==k.body.firstChild.nodeName.toLowerCase()){var m=k.head||k.getElementsByTagName("head")[0]||k.documentElement||k,p=k.createElement("script");p.text="document.write('<plaintext>')";m.insertBefore(p,m.firstChild);m.removeChild(p);b=k.body.lastChild}a.closed&&(a.isReopen=!0);f=d.util.iterate(function(){var d=l();if(d.length>a.lastIndex){H(c);e.status=200;e.error=null;b.innerText="";if(G(d,a,e))return"";M(e.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===k.readyState)return S(!0),
s("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){U(a)},a.reconnectInterval):U(a),!1},null);return!1}}catch(A){return e.error=!0,s("re-connecting",a.transport,a),z++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){U(a)},a.reconnectInterval):U(a):v(0,"maxReconnectOnClose reached"),g.execCommand("Stop"),g.close(),!1}})},close:function(){f&&f();g.execCommand("Stop");S(!0)}}}function P(b){null!=u?u.send(b):null!=K||null!=x?X(b):
null!=B?c.enableXDR&&d.util.checkCORSSupport()?(b=da(b),b.reconnect=!1,ga(b)):X(b):null!=C?X(b):null!=r?sa(b):(v(0,"No suspended connection available"),d.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking this method"))}function na(b,a){a||(a=da(b));a.transport="polling";a.method="GET";a.async=!1;a.withCredentials=!1;a.reconnect=!1;a.force=!0;a.suspend=!1;a.timeout=1E3;O(a)}function X(b){b=da(b);O(b)}function la(b){var a=
b;"object"===typeof a&&(a=b.data);return a}function da(b){var a=la(b),a={connected:!1,timeout:6E4,method:"POST",url:c.url,contentType:c.contentType,headers:c.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:c.withCredentials,async:c.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:c.enableXDR,uuid:c.uuid,dispatchUrl:c.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:c.trackMessageLength,
maxReconnectOnClose:c.maxReconnectOnClose,heartbeatTimer:c.heartbeatTimer,heartbeat:c.heartbeat};"object"===typeof b&&(a=d.util.extend(a,b));return a}function sa(b){var a=d.util.isBinary(b)?b:la(b),f;try{f=null!=c.dispatchUrl?c.webSocketPathDelimiter+c.dispatchUrl+c.webSocketPathDelimiter+a:a,r.canSendMessage?r.send(f):d.util.error("WebSocket not connected.")}catch(e){r.onclose=function(a){},m(),L("Websocket failed. Downgrading to Comet and resending "+b),X(b)}}function fa(b){b=d.util.parseJSON(b);
if(b.id!==y)if("undefined"!==typeof c.onLocalMessage)c.onLocalMessage(b.event);else if("undefined"!==typeof d.util.onLocalMessage)d.util.onLocalMessage(b.event)}function M(b,a,c,d){e.responseBody=b;e.transport=d;e.status=c;e.state=a;w()}function ca(b,a){if(a.readResponsesHeaders)try{var c=b.getResponseHeader("X-Cache-Date");c&&null!=c&&0<c.length&&(a.lastTimestamp=c.split(" ").pop());var f=b.getResponseHeader("X-Atmosphere-tracking-id");f&&null!=f&&(a.uuid=f.split(" ").pop())}catch(e){}else a.enableProtocol||
(a.lastTimestamp=d.util.now(),a.uuid=y)}function ja(b){ma(b,c);ma(b,d.util)}function ma(b,a){switch(b.state){case "messageReceived":z=0;if("undefined"!==typeof a.onMessage)a.onMessage(b);if("undefined"!==typeof a.onmessage)a.onmessage(b);break;case "error":if("undefined"!==typeof a.onError)a.onError(b);if("undefined"!==typeof a.onerror)a.onerror(b);break;case "opening":delete c.closed;if("undefined"!==typeof a.onOpen)a.onOpen(b);if("undefined"!==typeof a.onopen)a.onopen(b);break;case "messagePublished":if("undefined"!==
typeof a.onMessagePublished)a.onMessagePublished(b);break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(c,b);break;case "closedByClient":if("undefined"!==typeof a.onClientTimeout)a.onClientTimeout(c);break;case "re-opening":delete c.closed;if("undefined"!==typeof a.onReopen)a.onReopen(c,b);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(c,b);break;case "unsubscribe":case "closed":if("undefined"===typeof c.closed||!c.closed){if("undefined"!==
typeof a.onClose)a.onClose(b);if("undefined"!==typeof a.onclose)a.onclose(b)}c.closed=!0}}function S(b){"closed"!==e.state&&(e.state="closed",e.responseBody="",e.messages=[],e.status=b?200:501,w())}function w(){var b=function(a,b){b(e)};null==u&&null!=Q&&Q(e.responseBody);c.reconnect=c.mrequest;for(var a="string"===typeof e.responseBody,f=a&&c.trackMessageLength?0<e.messages.length?e.messages:[""]:Array(e.responseBody),g=0;g<f.length;g++)if(!(1<f.length&&0===f[g].length)&&(e.responseBody=a?d.util.trim(f[g]):
f[g],null==u&&null!=Q&&Q(e.responseBody),0!==e.responseBody.length||"messageReceived"!==e.state)){ja(e);if(0<E.length){"debug"===c.logLevel&&d.util.debug("Invoking "+E.length+" global callbacks: "+e.state);try{d.util.each(E,b)}catch(l){d.util.log(c.logLevel,["Callback exception"+l])}}if("function"===typeof c.callback){"debug"===c.logLevel&&d.util.debug("Invoking request callbacks");try{c.callback(e)}catch(k){d.util.log(c.logLevel,["Callback exception"+k])}}}}var c={timeout:3E5,method:"GET",headers:{},
contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,
reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,onError:function(b){},onClose:function(b){},onOpen:function(b){},onMessage:function(b){},onReopen:function(b,a){},onReconnect:function(b,a){},onMessagePublished:function(b){},onTransportFailure:function(b,a){},onLocalMessage:function(b){},onFailureToReconnect:function(b,a){},onClientTimeout:function(b){}},e=
{status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},r=null,x=null,K=null,B=null,C=null,$=!0,z=0,F=!1,Q=null,D,u=null,y=d.util.now(),W,Z;ea(f);this.subscribe=function(b){ea(b);A()};this.execute=function(){A()};this.close=function(){k()};this.disconnect=function(){l()};this.getUrl=function(){return c.url};this.push=function(b,a){if(null!=
a){var f=c.dispatchUrl;c.dispatchUrl=a;P(b);c.dispatchUrl=f}else P(b)};this.getUUID=function(){return c.uuid};this.pushLocal=function(b){if(0!==b.length)try{u?u.localSend(b):D&&D.signal("localMessage",d.util.stringifyJSON({id:y,event:b}))}catch(a){d.util.error(a)}};this.enableProtocol=function(b){return c.enableProtocol};this.request=c;this.response=e},subscribe:function(f,g,l){"function"===typeof g&&d.addCallback(g);"string"!==typeof f?l=f:l.url=f;V="undefined"!==typeof l&&"undefined"!==typeof l.uuid?
l.uuid:0;f=new d.AtmosphereRequest(l);f.execute();return q[q.length]=f},unsubscribe:function(){if(0<q.length)for(var f=[].concat(q),d=0;d<f.length;d++){var l=f[d];l.close();clearTimeout(l.response.request.id);l.heartbeatTimer&&clearTimeout(l.heartbeatTimer)}q=[];E=[]},unsubscribeUrl:function(d){var g=-1;if(0<q.length)for(var l=0;l<q.length;l++){var k=q[l];if(k.getUrl()===d){k.close();clearTimeout(k.response.request.id);k.heartbeatTimer&&clearTimeout(k.heartbeatTimer);g=l;break}}0<=g&&q.splice(g,1)},
addCallback:function(f){-1===d.util.inArray(f,E)&&E.push(f)},removeCallback:function(f){f=d.util.inArray(f,E);-1!==f&&E.splice(f,1)},util:{browser:{},parseHeaders:function(d){for(var g,l=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,k={};g=l.exec(d);)k[g[1]]=g[2];return k},now:function(){return(new Date).getTime()},isArray:function(d){return"[object Array]"===Object.prototype.toString.call(d)},inArray:function(d,g){if(!Array.prototype.indexOf){for(var l=g.length,k=0;k<l;++k)if(g[k]===d)return k;return-1}return g.indexOf(d)},
isBinary:function(d){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(d))},isFunction:function(d){return"[object Function]"===Object.prototype.toString.call(d)},getAbsoluteURL:function(d){var g=document.createElement("div");g.innerHTML='<a href="'+d+'"/>';return encodeURI(decodeURI(g.firstChild.href))},prepareURL:function(f){var g=d.util.now(),l=f.replace(/([?&])_=[^&]*/,"$1_="+g);return l+(l===f?(/\?/.test(f)?"&":"?")+"_="+g:"")},trim:function(d){return String.prototype.trim?
d.toString().trim():d.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(f){function g(f,g){g=d.util.isFunction(g)?g():null==g?"":g;m.push(encodeURIComponent(f)+"="+encodeURIComponent(g))}function l(f,k){var m;if(d.util.isArray(k))d.util.each(k,function(d,k){/\[\]$/.test(f)?g(f,k):l(f+"["+("object"===typeof k?d:"")+"]",k)});else if("[object Object]"===Object.prototype.toString.call(k))for(m in k)l(f+"["+m+"]",k[m]);else g(f,k)}var k,m=[];for(k in f)l(k,f[k]);
return m.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(d){return!1}},iterate:function(d,g){var l;g=g||0;(function m(){l=setTimeout(function(){!1!==d()&&m()},g)})();return function(){clearTimeout(l)}},each:function(f,g,l){if(f){var k,m=0,q=f.length;k=d.util.isArray(f);if(l)if(k)for(;m<q&&(k=g.apply(f[m],l),!1!==k);m++);else for(m in f){if(k=g.apply(f[m],l),!1===k)break}else if(k)for(;m<q&&(k=g.call(f[m],m,f[m]),!1!==k);m++);else for(m in f)if(k=
g.call(f[m],m,f[m]),!1===k)break;return f}},extend:function(d){var g,l,k;for(g=1;g<arguments.length;g++)if(null!=(l=arguments[g]))for(k in l)d[k]=l[k];return d},on:function(d,g,l){d.addEventListener?d.addEventListener(g,l,!1):d.attachEvent&&d.attachEvent("on"+g,l)},off:function(d,g,l){d.removeEventListener?d.removeEventListener(g,l,!1):d.detachEvent&&d.detachEvent("on"+g,l)},log:function(d,g){if(window.console){var l=window.console[d];"function"===typeof l&&l.apply(window.console,g)}},warn:function(){d.util.log("warn",
arguments)},info:function(){d.util.log("info",arguments)},debug:function(){d.util.log("debug",arguments)},error:function(){d.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(d){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(g){}}},parseJSON:function(d){return d?window.JSON&&window.JSON.parse?window.JSON.parse(d):(new Function("return "+d))():null},stringifyJSON:function(d){function g(d){return'"'+d.replace(k,function(d){var f=m[d];return"string"===
typeof f?f:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"'}function l(d){return 10>d?"0"+d:d}var k=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,m={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(d):function A(d,f){var k,m,q,p=f[d];q=typeof p;p&&"object"===typeof p&&"function"===typeof p.toJSON&&(p=p.toJSON(d),q=typeof p);
switch(q){case "string":return g(p);case "number":return isFinite(p)?String(p):"null";case "boolean":return String(p);case "object":if(!p)return"null";switch(Object.prototype.toString.call(p)){case "[object Date]":return isFinite(p.valueOf())?'"'+p.getUTCFullYear()+"-"+l(p.getUTCMonth()+1)+"-"+l(p.getUTCDate())+"T"+l(p.getUTCHours())+":"+l(p.getUTCMinutes())+":"+l(p.getUTCSeconds())+'Z"':"null";case "[object Array]":m=p.length;q=[];for(k=0;k<m;k++)q.push(A(k,p)||"null");return"["+q.join(",")+"]";
default:q=[];for(k in p)Y.call(p,k)&&(m=A(k,p))&&q.push(g(k)+":"+m);return"{"+q.join(",")+"}"}}}("",{"":d})},checkCORSSupport:function(){return d.util.browser.msie&&!window.XDomainRequest&&11>+d.util.browser.version.split(".")[0]||d.util.browser.opera&&12>+d.util.browser.version.split(".")||"KreaTVWebKit/531"===d.util.trim(navigator.userAgent).slice(0,16)||"kreatel"===d.util.trim(navigator.userAgent).slice(-7).toLowerCase()?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")?!0:!1}}};d.util.now();
(function(){var f=navigator.userAgent.toLowerCase(),f=/(chrome)[ \/]([\w.]+)/.exec(f)||/(webkit)[ \/]([\w.]+)/.exec(f)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(f)||/(msie) ([\w.]+)/.exec(f)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(f)||0>f.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(f)||[];d.util.browser[f[1]||""]=!0;d.util.browser.version=f[2]||"0";d.util.browser.trident&&(d.util.browser.msie=!0);if(d.util.browser.msie||d.util.browser.mozilla&&1===+d.util.browser.version.split(".")[0])d.util.storage=
!1})();d.util.on(window,"unload",function(f){d.unsubscribe()});d.util.on(window,"keypress",function(d){(27===d.charCode||27===d.keyCode)&&d.preventDefault&&d.preventDefault()});d.util.on(window,"offline",function(){d.unsubscribe()});return d});