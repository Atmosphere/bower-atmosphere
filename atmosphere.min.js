!function(e,n){"function"==typeof define&&define.amd?define(n):"undefined"!=typeof exports?module.exports=n():e.atmosphere=n()}(this,function(){"use strict";var e,n="2.2.12-javascript",t={},o=!1,r=[],a=[],i=0,s=Object.prototype.hasOwnProperty;return t={onError:function(){},onClose:function(){},onOpen:function(){},onReopen:function(){},onMessage:function(){},onReconnect:function(){},onMessagePublished:function(){},onTransportFailure:function(){},onLocalMessage:function(){},onFailureToReconnect:function(){},onClientTimeout:function(){},onOpenAfterResume:function(){},WebsocketApiAdapter:function(e){var n,o;return e.onMessage=function(e){o.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){o.onmessage({data:e.responseBody})},e.onOpen=function(e){o.onopen(e)},o={close:function(){n.close()},send:function(e){n.push(e)},onmessage:function(){},onopen:function(){},onclose:function(){},onerror:function(){}},n=new t.subscribe(e),o},AtmosphereRequest:function(e){function r(){Tn=!0,Cn=!1,Sn=0,hn=null,bn=null,vn=null,wn=null}function s(){p(),r()}function c(e){return"debug"==e?"debug"===gn.logLevel:"info"==e?"info"===gn.logLevel||"debug"===gn.logLevel:"warn"==e?"warn"===gn.logLevel||"info"===gn.logLevel||"debug"===gn.logLevel:"error"==e?"error"===gn.logLevel||"warn"===gn.logLevel||"info"===gn.logLevel||"debug"===gn.logLevel:!1}function l(e){c("debug")&&t.util.debug(new Date+" Atmosphere: "+e)}function u(e,n){return""===mn.partialMessage&&"streaming"===n.transport&&e.responseText.length>n.maxStreamingLength?!0:!1}function d(){if(gn.enableProtocol&&!gn.firstMessage){var e="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+gn.uuid;t.util.each(gn.headers,function(n,o){var r=t.util.isFunction(o)?o.call(this,gn,gn,mn):o;null!=r&&(e+="&"+encodeURIComponent(n)+"="+encodeURIComponent(r))});var n=gn.url.replace(/([?&])_=[^&]*/,e);n+=n===gn.url?(/\?/.test(gn.url)?"&":"?")+e:"";var o={connected:!1},r=new t.AtmosphereRequest(o);r.connectTimeout=gn.connectTimeout,r.attachHeadersAsQueryString=!1,r.dropHeaders=!0,r.url=n,r.contentType="text/plain",r.transport="polling",r.method="GET",r.data="",r.heartbeat=null,gn.enableXDR&&(r.enableXDR=gn.enableXDR),r.async=gn.closeAsync,G("",r)}}function f(){l("Closing (AtmosphereRequest._close() called)"),Cn=!0,gn.reconnectId&&(clearTimeout(gn.reconnectId),delete gn.reconnectId),gn.heartbeatTimer&&clearTimeout(gn.heartbeatTimer),gn.reconnect=!1,mn.request=gn,mn.state="unsubscribe",mn.responseBody="",mn.status=408,mn.partialMessage="",un(),d(),p()}function p(){mn.partialMessage="",gn.id&&clearTimeout(gn.id),gn.heartbeatTimer&&clearTimeout(gn.heartbeatTimer),gn.reconnectId&&(clearTimeout(gn.reconnectId),delete gn.reconnectId),null!=wn&&(wn.close(),wn=null),null!=yn&&(yn.abort(),yn=null),null!=vn&&(vn.abort(),vn=null),null!=hn&&(hn.canSendMessage&&(l("invoking .close() on WebSocket object"),hn.close()),hn=null),null!=bn&&(bn.close(),bn=null),g()}function g(){null!=dn&&(clearInterval(fn),document.cookie=pn+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",dn.signal("close",{reason:"",heir:Cn?(dn.get("children")||[])[0]:On}),dn.close()),null!=In&&In.close()}function m(e){s(),gn=t.util.extend(gn,e),gn.mrequest=gn.reconnect,gn.reconnect||(gn.reconnect=!0)}function h(){return null!=gn.webSocketImpl||window.WebSocket||window.MozWebSocket}function b(){var e=t.util.getAbsoluteURL(gn.url.toLowerCase()),n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e),o=!(!n||n[1]==window.location.protocol&&n[2]==window.location.hostname&&(n[3]||("http:"===n[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443)));return window.EventSource&&(!o||!t.util.browser.safari||t.util.browser.vmajor>=7)}function v(){if(gn.shared){if(In=w(gn),null!=In&&(c("debug")&&t.util.debug("Storage service available. All communication will be local"),In.open(gn)))return;c("debug")&&t.util.debug("No Storage service available."),In=null}gn.firstMessage=0==i?!0:!1,gn.isOpen=!1,gn.ctime=t.util.now(),0===gn.uuid&&(gn.uuid=i),mn.closedByClientTimeout=!1,"websocket"!==gn.transport&&"sse"!==gn.transport?P(gn):"websocket"===gn.transport?h()?I(!1):M("Websocket is not supported, using request.fallbackTransport ("+gn.fallbackTransport+")"):"sse"===gn.transport&&(b()?x(!1):M("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+gn.fallbackTransport+")"))}function w(e){function n(e,n){var t,o=e.length;for(t=0;o>t;t++)e[t]===n&&e.splice(t,1);return o!==e.length}function o(n){var o=t.util.parseJSON(n),r=o.data;if("c"===o.target)switch(o.type){case"open":T("opening","local",gn);break;case"close":s||(s=!0,"aborted"===r.reason?f():r.heir===On?v():setTimeout(function(){v()},100));break;case"message":rn(r,"messageReceived",200,e.transport);break;case"localMessage":on(r)}}function r(){var e=new RegExp("(?:^|; )("+encodeURIComponent(c)+")=([^;]*)").exec(document.cookie);return e?t.util.parseJSON(decodeURIComponent(e[2])):void 0}var a,i,s,c="atmosphere-"+e.url,l={storage:function(){function r(e){e.key===c&&e.newValue&&o(e.newValue)}if(t.util.storage){var a=window.localStorage,i=function(e){return t.util.parseJSON(a.getItem(c+"-"+e))},s=function(e,n){a.setItem(c+"-"+e,t.util.stringifyJSON(n))};return{init:function(){return s("children",i("children").concat([On])),t.util.on(window,"storage",r),i("opened")},signal:function(e,n){a.setItem(c,t.util.stringifyJSON({target:"p",type:e,data:n}))},close:function(){var o=i("children");t.util.off(window,"storage",r),o&&n(o,e.id)&&s("children",o)}}}},windowref:function(){var e=window.open("",c.replace(/\W/g,""));if(e&&!e.closed&&e.callbacks)return{init:function(){return e.callbacks.push(o),e.children.push(On),e.opened},signal:function(n,o){!e.closed&&e.fire&&e.fire(t.util.stringifyJSON({target:"p",type:n,data:o}))},close:function(){s||(n(e.callbacks,o),n(e.children,On))}}}};return a=r(),!a||t.util.now()-a.ts>1e3||!(i=l.storage()||l.windowref())?void 0:{open:function(){var n;return fn=setInterval(function(){var e=a;a=r(),a&&e.ts!==a.ts||o(t.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),n=i.init(),n&&setTimeout(function(){T("opening","local",e)},50),n},send:function(e){i.signal("send",e)},localSend:function(e){i.signal("localSend",t.util.stringifyJSON({id:On,event:e}))},close:function(){Cn||(clearInterval(fn),i.signal("close"),i.close())}}}function y(){function e(e){var n=t.util.parseJSON(e),o=n.data;if("p"===n.target)switch(n.type){case"send":z(o);break;case"localSend":on(o);break;case"close":f()}}function n(){document.cookie=pn+"="+encodeURIComponent(t.util.stringifyJSON({ts:t.util.now()+1,heir:(o.get("children")||[])[0]}))+"; path=/"}var o,r="atmosphere-"+gn.url,a={storage:function(){function n(n){n.key===r&&n.newValue&&e(n.newValue)}if(t.util.storage){var o=window.localStorage;return{init:function(){t.util.on(window,"storage",n)},signal:function(e,n){o.setItem(r,t.util.stringifyJSON({target:"c",type:e,data:n}))},get:function(e){return t.util.parseJSON(o.getItem(r+"-"+e))},set:function(e,n){o.setItem(r+"-"+e,t.util.stringifyJSON(n))},close:function(){t.util.off(window,"storage",n),o.removeItem(r),o.removeItem(r+"-opened"),o.removeItem(r+"-children")}}}},windowref:function(){var n,o=r.replace(/\W/g,""),a=document.getElementById(o);return a||(a=document.createElement("div"),a.id=o,a.style.display="none",a.innerHTML='<iframe name="'+o+'" />',document.body.appendChild(a)),n=a.firstChild.contentWindow,{init:function(){n.callbacks=[e],n.fire=function(e){var t;for(t=0;t<n.callbacks.length;t++)n.callbacks[t](e)}},signal:function(e,o){!n.closed&&n.fire&&n.fire(t.util.stringifyJSON({target:"c",type:e,data:o}))},get:function(e){return n.closed?null:n[e]},set:function(e,t){n.closed||(n[e]=t)},close:function(){}}}};xn=function(e){o.signal("message",e)},o=a.storage()||a.windowref(),o.init(),c("debug")&&t.util.debug("Installed StorageService "+o),o.set("children",[]),null==o.get("opened")||o.get("opened")||o.set("opened",!1),pn=encodeURIComponent(r),n(),fn=setInterval(n,1e3),dn=o}function T(e,n,t){if(gn.shared&&"local"!==n&&y(),null!=dn&&dn.set("opened",!0),t.close=function(){f()},Sn>0&&"re-connecting"===e)t.isReopen=!0,X(mn);else if(null==mn.error){mn.request=t;var o=mn.state;mn.state=e;var r=mn.transport;mn.transport=n;var a=mn.responseBody;un(),mn.responseBody=a,mn.state=o,mn.transport=r}}function S(e){e.transport="jsonp";var n,o=gn;null!=e&&"undefined"!=typeof e&&(o=e),yn={open:function(){function r(){o.lastIndex=0,o.openId&&clearTimeout(o.openId),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),o.reconnect&&Sn++<o.maxReconnectOnClose?(T("re-connecting",o.transport,o),H(yn,o,e.reconnectInterval),o.openId=setTimeout(function(){q(o)},o.reconnectInterval+1e3)):B(0,"maxReconnectOnClose reached")}function a(){var t=o.url;null!=o.dispatchUrl&&(t+=o.dispatchUrl);var a=o.data;o.attachHeadersAsQueryString&&(t=D(o),""!==a&&(t+="&X-Atmosphere-Post-Body="+encodeURIComponent(a)),a="");var s=document.head||document.getElementsByTagName("head")[0]||document.documentElement;n=document.createElement("script"),n.src=t+"&jsonpTransport="+i,n.clean=function(){n.clean=n.onerror=n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),2===++e.scriptCount&&(e.scriptCount=1,r())},n.onload=n.onreadystatechange=function(){l("jsonp.onload"),(!n.readyState||/loaded|complete/.test(n.readyState))&&n.clean()},n.onerror=function(){l("jsonp.onerror"),e.scriptCount=1,n.clean()},s.insertBefore(n,s.firstChild)}var i="atmosphere"+ ++On;window[i]=function(n){if(l("jsonp.window"),e.scriptCount=0,o.reconnect&&-1===o.maxRequest||o.requestCount++<o.maxRequest){if(o.executeCallbackBeforeReconnect||H(yn,o,o.pollingInterval),null!=n&&"string"!=typeof n)try{n=n.message}catch(r){}var a=U(n,o,mn);a||rn(mn.responseBody,"messageReceived",200,o.transport),o.executeCallbackBeforeReconnect&&H(yn,o,o.pollingInterval),A(o)}else t.util.log(gn.logLevel,["JSONP reconnect maximum try reached "+gn.requestCount]),B(0,"maxRequest reached")},setTimeout(function(){a()},50)},abort:function(){n&&n.clean&&n.clean()}},yn.open()}function R(e){return null!=gn.webSocketImpl?gn.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}function k(){return D(gn,t.util.getAbsoluteURL(gn.webSocketUrl||gn.url)).replace(/^http/,"ws")}function C(){var e=D(gn);return e}function x(e){mn.transport="sse";var n=C();if(c("debug")&&(t.util.debug("Invoking executeSSE"),t.util.debug("Using URL: "+n)),e&&!gn.reconnect)return void(null!=bn&&p());try{bn=new EventSource(n,{withCredentials:gn.withCredentials})}catch(o){return B(0,o),void M("SSE failed. Downgrading to fallback transport and resending")}gn.connectTimeout>0&&(gn.id=setTimeout(function(){e||p()},gn.connectTimeout)),bn.onopen=function(){l("sse.onopen"),A(gn),c("debug")&&t.util.debug("SSE successfully opened"),gn.enableProtocol?gn.isReopen&&(gn.isReopen=!1,T("re-opening",gn.transport,gn)):e?T("re-opening","sse",gn):T("opening","sse",gn),e=!0,"POST"===gn.method&&(mn.state="messageReceived",bn.send(gn.data))},bn.onmessage=function(e){if(l("sse.onmessage"),A(gn),!gn.enableXDR&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host)return void t.util.log(gn.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]);mn.state="messageReceived",mn.status=200,e=e.data;var n=U(e,gn,mn);n||(un(),mn.responseBody="",mn.messages=[])},bn.onerror=function(){l("sse.onerror"),clearTimeout(gn.id),gn.heartbeatTimer&&clearTimeout(gn.heartbeatTimer),mn.closedByClientTimeout||(ln(e),p(),Cn?t.util.log(gn.logLevel,["SSE closed normally"]):e?gn.reconnect&&"sse"===mn.transport&&(Sn++<gn.maxReconnectOnClose?(T("re-connecting",gn.transport,gn),gn.reconnectInterval>0?gn.reconnectId=setTimeout(function(){x(!0)},gn.reconnectInterval):x(!0),mn.responseBody="",mn.messages=[]):(t.util.log(gn.logLevel,["SSE reconnect maximum try reached "+Sn]),B(0,"maxReconnectOnClose reached"))):M("SSE failed. Downgrading to fallback transport and resending"))}}function I(e){mn.transport="websocket";var n=k(gn.url);if(c("debug")&&t.util.debug("Invoking executeWebSocket, using URL: "+n),e&&!gn.reconnect)return void(null!=hn&&p());hn=R(n),null!=gn.webSocketBinaryType&&(hn.binaryType=gn.webSocketBinaryType),gn.connectTimeout>0&&(gn.id=setTimeout(function(){if(e);else{var n={code:1002,reason:"",wasClean:!1};hn.onclose(n);try{p()}catch(t){}}},gn.connectTimeout)),hn.onopen=function(){l("websocket.onopen"),A(gn),o=!1,c("debug")&&t.util.debug("Websocket successfully opened");var n=e;null!=hn&&(hn.canSendMessage=!0),gn.enableProtocol||(e=!0,n?T("re-opening","websocket",gn):T("opening","websocket",gn)),null!=hn&&"POST"===gn.method&&(mn.state="messageReceived",hn.send(gn.data))},hn.onmessage=function(n){l("websocket.onmessage"),A(gn),gn.enableProtocol&&(e=!0),mn.state="messageReceived",mn.status=200,n=n.data;var t="string"==typeof n;if(t){var o=U(n,gn,mn);o||(un(),mn.responseBody="",mn.messages=[])}else{if(n=O(gn,n),""===n)return;mn.responseBody=n,un(),mn.responseBody=null}},hn.onerror=function(){l("websocket.onerror"),clearTimeout(gn.id),gn.heartbeatTimer&&clearTimeout(gn.heartbeatTimer)},hn.onclose=function(n){if(l("websocket.onclose"),clearTimeout(gn.id),"closed"!==mn.state){var r=n.reason;if(""===r)switch(n.code){case 1e3:r="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:r="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:r="The endpoint is terminating the connection due to a protocol error.";break;case 1003:r="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:r="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:r="Unknown: no status code was provided even though one was expected.";break;case 1006:r="Connection was closed abnormally (that is, with no close frame being sent)."}if(c("warn")&&t.util.warn("Websocket closed, reason: "+r+" - wasClean: "+n.wasClean),mn.closedByClientTimeout||o)return void(gn.reconnectId&&(clearTimeout(gn.reconnectId),delete gn.reconnectId));ln(e),mn.state="closed",Cn?t.util.log(gn.logLevel,["Websocket closed normally"]):e?gn.reconnect&&"websocket"===mn.transport&&(p(),Sn++<gn.maxReconnectOnClose?(T("re-connecting",gn.transport,gn),gn.reconnectInterval>0?gn.reconnectId=setTimeout(function(){mn.responseBody="",mn.messages=[],I(!0)},gn.reconnectInterval):(mn.responseBody="",mn.messages=[],I(!0))):(t.util.log(gn.logLevel,["Websocket reconnect maximum try reached "+gn.requestCount]),c("warn")&&t.util.warn("Websocket error, reason: "+n.reason),B(0,"maxReconnectOnClose reached"))):M("Websocket failed on first connection attempt. Downgrading to "+gn.fallbackTransport+" and resending")}};var r=navigator.userAgent.toLowerCase(),a=r.indexOf("android")>-1;a&&void 0===hn.url&&hn.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function O(e,n){var o=n;if("polling"===e.transport)return o;if(e.enableProtocol&&e.firstMessage&&0!==t.util.trim(n).length){var r=e.trackMessageLength?1:0,a=n.split(e.messageDelimiter);if(a.length<=r+1)return o;if(e.firstMessage=!1,e.uuid=t.util.trim(a[r]),a.length<=r+2&&t.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),Rn=parseInt(t.util.trim(a[r+1]),10),kn=a[r+2],"long-polling"!==e.transport&&q(e),i=e.uuid,o="",r=e.trackMessageLength?4:3,a.length>r+1)for(var s=r;s<a.length;s++)o+=a[s],s+1!==a.length&&(o+=e.messageDelimiter);0!==e.ackInterval&&setTimeout(function(){z("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10?t.util.log(gn.logLevel,["Receiving unexpected data from IE"]):q(e);return o}function A(e){clearTimeout(e.id),e.timeout>0&&"polling"!==e.transport&&(e.id=setTimeout(function(){L(e),d(),p()},e.timeout))}function L(){mn.closedByClientTimeout=!0,mn.state="closedByClient",mn.responseBody="",mn.status=408,mn.messages=[],un()}function B(e,n){p(),clearTimeout(gn.id),mn.state="error",mn.reasonPhrase=n,mn.responseBody="",mn.status=e,mn.messages=[],un()}function U(e,n,t){if(e=O(n,e),0===e.length)return!0;if(t.responseBody=e,n.trackMessageLength){e=t.partialMessage+e;var o=[],r=e.indexOf(n.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),i=+a;if(isNaN(i))throw new Error('message length "'+a+'" is not a number');r+=n.messageDelimiter.length,r+i>e.length?r=-1:(o.push(e.substring(r,r+i)),e=e.substring(r+i,e.length),r=e.indexOf(n.messageDelimiter))}return t.partialMessage=e,0!==o.length?(t.responseBody=o.join(n.messageDelimiter),t.messages=o,!1):(t.responseBody="",t.messages=[],!0)}}return t.responseBody=e,t.messages=[e],!1}function M(e){t.util.log(gn.logLevel,[e]),"undefined"!=typeof gn.onTransportFailure?gn.onTransportFailure(e,gn):"undefined"!=typeof t.util.onTransportFailure&&t.util.onTransportFailure(e,gn),gn.transport=gn.fallbackTransport;var n=-1===gn.connectTimeout?0:gn.connectTimeout;gn.reconnect&&"none"!==gn.transport||null==gn.transport?(gn.method=gn.fallbackMethod,mn.transport=gn.fallbackTransport,gn.fallbackTransport="none",n>0?gn.reconnectId=setTimeout(function(){v()},n):v()):B(500,"Unable to reconnect with fallback transport")}function D(e,o){var r=gn;return null!=e&&"undefined"!=typeof e&&(r=e),null==o&&(o=r.url),r.attachHeadersAsQueryString?-1!==o.indexOf("X-Atmosphere-Framework")?o:(o+=-1!==o.indexOf("?")?"&":"?",o+="X-Atmosphere-tracking-id="+r.uuid,o+="&X-Atmosphere-Framework="+n,o+="&X-Atmosphere-Transport="+r.transport,r.trackMessageLength&&(o+="&X-Atmosphere-TrackMessageSize=true"),null!==r.heartbeat&&null!==r.heartbeat.server&&(o+="&X-Heartbeat-Server="+r.heartbeat.server),""!==r.contentType&&(o+="&Content-Type="+("websocket"===r.transport?r.contentType:encodeURIComponent(r.contentType))),r.enableProtocol&&(o+="&X-atmo-protocol=true"),t.util.each(r.headers,function(n,a){var i=t.util.isFunction(a)?a.call(this,r,e,mn):a;null!=i&&(o+="&"+encodeURIComponent(n)+"="+encodeURIComponent(i))}),o):o}function q(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,T("re-opening",e.transport,e);else{if("messageReceived"!==mn.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;F(mn)}else e.isOpen=!0,T("opening",e.transport,e);E(e)}function E(e){if(null!=e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),!isNaN(Rn)&&Rn>0){var n=function(){c("debug")&&t.util.debug("Sending heartbeat"),z(kn),e.heartbeatTimer=setTimeout(n,Rn)};e.heartbeatTimer=setTimeout(n,Rn)}}function P(e){var n=gn;if((null!=e||"undefined"!=typeof e)&&(n=e),n.lastIndex=0,n.readyState=0,"jsonp"===n.transport||n.enableXDR&&t.util.checkCORSSupport())return void S(n);if(t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10){if("streaming"===n.transport)return void(n.enableXDR&&window.XDomainRequest?J(n):_(n));if(n.enableXDR&&window.XDomainRequest)return void J(n)}var o=function(t){n.lastIndex=0,t||n.reconnect&&Sn++<n.maxReconnectOnClose?(mn.ffTryingReconnect=!0,T("re-connecting",e.transport,e),H(i,n,e.reconnectInterval)):B(0,"maxReconnectOnClose reached")},r=function(e){t._beforeUnloadState?(t.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){o(e)},5e3)):o(e)},a=function(){mn.errorHandled=!0,p(),r(!1)};if(n.force||n.reconnect&&(-1===n.maxRequest||n.requestCount++<n.maxRequest)){n.force=!1;var i=t.util.xhr();i.hasData=!1,j(i,n,!0),n.suspend&&(vn=i),"polling"!==n.transport&&(mn.transport=n.transport,i.onabort=function(){l("ajaxrequest.onabort"),ln(!0)},i.onerror=function(){l("ajaxrequest.onerror"),mn.error=!0,mn.ffTryingReconnect=!0;try{mn.status=XMLHttpRequest.status}catch(e){mn.status=500}mn.status||(mn.status=500),mn.errorHandled||(p(),r(!1))}),i.onreadystatechange=function(){if(l("ajaxRequest.onreadystatechange, new state: "+i.readyState),Cn)return void l("onreadystatechange has been ignored due to _abortingConnection flag");mn.error=null;var o=!1,s=!1;if("streaming"===n.transport&&n.readyState>2&&4===i.readyState)return p(),void r(!1);if(n.readyState=i.readyState,"streaming"===n.transport&&i.readyState>=3?s=!0:"long-polling"===n.transport&&4===i.readyState&&(s=!0),A(gn),"polling"!==n.transport){var c=200;if(4===i.readyState&&(c=i.status>1e3?0:i.status),!n.reconnectOnServerError&&c>=300&&600>c)return void B(c,i.statusText);if(c>=300||0===c)return void a();n.enableProtocol&&e.firstMessage||2!==i.readyState||(t.util.browser.mozilla&&mn.ffTryingReconnect?(mn.ffTryingReconnect=!1,setTimeout(function(){mn.ffTryingReconnect||q(n)},500)):q(n))}else 4===i.readyState&&(s=!0);if(s){var d=i.responseText;if(mn.errorHandled=!1,"long-polling"===n.transport&&0===t.util.trim(d).length)return void(i.hasData?i.hasData=!1:r(!0));if(i.hasData=!0,an(i,gn),"streaming"===n.transport)if(t.util.browser.opera)t.util.iterate(function(){if(500!==mn.status&&i.responseText.length>n.lastIndex){try{mn.status=i.status,mn.headers=t.util.parseHeaders(i.getAllResponseHeaders()),an(i,gn)}catch(e){mn.status=404}A(gn),mn.state="messageReceived";var r=i.responseText.substring(n.lastIndex);if(n.lastIndex=i.responseText.length,o=U(r,n,mn),o||un(),u(i,n))return void N(i,n)}else if(mn.status>400)return n.lastIndex=i.responseText.length,!1},0);else{var f=d.substring(n.lastIndex,d.length);if(o=U(f,n,mn),n.lastIndex=d.length,o)return}else o=U(d,n,mn);var g=u(i,n);try{mn.status=i.status,mn.headers=t.util.parseHeaders(i.getAllResponseHeaders()),an(i,n)}catch(m){mn.status=404}mn.state=n.suspend?0===mn.status?"closed":"messageReceived":"messagePublished";var h=!g&&"streaming"!==e.transport&&"polling"!==e.transport;h&&!n.executeCallbackBeforeReconnect&&H(i,n,n.pollingInterval),0===mn.responseBody.length||o||un(),h&&n.executeCallbackBeforeReconnect&&H(i,n,n.pollingInterval),g&&N(i,n)}};try{i.send(n.data),Tn=!0}catch(s){t.util.log(n.logLevel,["Unable to connect to "+n.url]),B(0,s)}}else"debug"===n.logLevel&&t.util.log(n.logLevel,["Max re-connection reached."]),B(0,"maxRequest reached")}function N(e,n){mn.messages=[],n.isReopen=!0,f(),Cn=!1,H(e,n,500)}function j(e,o,r){var a=o.url;null!=o.dispatchUrl&&"POST"===o.method&&(a+=o.dispatchUrl),a=D(o,a),a=t.util.prepareURL(a),r&&(e.open(o.method,a,o.async),o.connectTimeout>0&&(o.id=setTimeout(function(){0===o.requestCount&&(p(),rn("Connect timeout","closed",200,o.transport))},o.connectTimeout))),gn.withCredentials&&"websocket"!==gn.transport&&"withCredentials"in e&&(e.withCredentials=!0),gn.dropHeaders||(e.setRequestHeader("X-Atmosphere-Framework",n),e.setRequestHeader("X-Atmosphere-Transport",o.transport),null!==o.heartbeat&&null!==o.heartbeat.server&&e.setRequestHeader("X-Heartbeat-Server",e.heartbeat.server),o.trackMessageLength&&e.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),e.setRequestHeader("X-Atmosphere-tracking-id",o.uuid),t.util.each(o.headers,function(n,a){var i=t.util.isFunction(a)?a.call(this,e,o,r,mn):a;null!=i&&e.setRequestHeader(n,i)})),""!==o.contentType&&e.setRequestHeader("Content-Type",o.contentType)}function H(e,n,t){if(!mn.closedByClientTimeout&&(n.reconnect||n.suspend&&Tn)){var o=0;e&&e.readyState>1&&(o=e.status>1e3?0:e.status),mn.status=0===o?204:o,mn.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(n.id),n.reconnectId&&(clearTimeout(n.reconnectId),delete n.reconnectId),t>0?gn.reconnectId=setTimeout(function(){P(n)},t):P(n)}}function X(e){e.state="re-connecting",sn(e)}function F(e){e.state="openAfterResume",sn(e),e.state="messageReceived"}function J(e){"polling"!==e.transport?(wn=W(e),wn.open()):W(e).open()}function W(e){var n=gn;null!=e&&"undefined"!=typeof e&&(n=e);var o=n.transport,r=0,a=new window.XDomainRequest,i=function(){"long-polling"===n.transport&&n.reconnect&&(-1===n.maxRequest||n.requestCount++<n.maxRequest)&&(a.status=200,J(n))},s=n.rewriteURL||function(e){var n=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(n&&n[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+n[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+n[2]+"&").replace(/&$/,"")}return e};a.onprogress=function(){c(a)},a.onerror=function(){"polling"!==n.transport&&(p(),Sn++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){T("re-connecting",e.transport,e),J(n)},n.reconnectInterval):(T("re-connecting",e.transport,e),J(n)):B(0,"maxReconnectOnClose reached"))},a.onload=function(){};var c=function(e){clearTimeout(n.id);var a=e.responseText;if(a=a.substring(r),r+=a.length,"polling"!==o){A(n);var s=U(a,n,mn);if("long-polling"===o&&0===t.util.trim(a).length)return;n.executeCallbackBeforeReconnect&&i(),s||rn(mn.responseBody,"messageReceived",200,o),n.executeCallbackBeforeReconnect||i()}};return{open:function(){var e=n.url;null!=n.dispatchUrl&&(e+=n.dispatchUrl),e=D(n,e),a.open(n.method,s(e)),"GET"===n.method?a.send():a.send(n.data),n.connectTimeout>0&&(n.id=setTimeout(function(){0===n.requestCount&&(p(),rn("Connect timeout","closed",200,n.transport))},n.connectTimeout))},close:function(){a.abort()}}}function _(e){wn=$(e),wn.open()}function $(e){var n=gn;null!=e&&"undefined"!=typeof e&&(n=e);var o,r=new window.ActiveXObject("htmlfile");r.open(),r.close();var a=n.url;return null!=n.dispatchUrl&&(a+=n.dispatchUrl),"polling"!==n.transport&&(mn.transport=n.transport),{open:function(){var e=r.createElement("iframe");a=D(n),""!==n.data&&(a+="&X-Atmosphere-Post-Body="+encodeURIComponent(n.data)),a=t.util.prepareURL(a),e.src=a,r.body.appendChild(e);var i=e.contentDocument||e.contentWindow.document;o=t.util.iterate(function(){try{if(!i.firstChild)return;var e=i.body?i.body.lastChild:i,a=function(){var n=e.cloneNode(!0);n.appendChild(i.createTextNode("."));var t=n.innerText;return t=t.substring(0,t.length-1)};if(!i.body||!i.body.firstChild||"pre"!==i.body.firstChild.nodeName.toLowerCase()){var s=i.head||i.getElementsByTagName("head")[0]||i.documentElement||i,c=i.createElement("script");c.text="document.write('<plaintext>')",s.insertBefore(c,s.firstChild),s.removeChild(c),e=i.body.lastChild}return n.closed&&(n.isReopen=!0),o=t.util.iterate(function(){var t=a();if(t.length>n.lastIndex){A(gn),mn.status=200,mn.error=null,e.innerText="";var o=U(t,n,mn);if(o)return"";rn(mn.responseBody,"messageReceived",200,n.transport)}return n.lastIndex=0,"complete"===i.readyState?(ln(!0),T("re-connecting",n.transport,n),n.reconnectInterval>0?n.reconnectId=setTimeout(function(){_(n)},n.reconnectInterval):_(n),!1):void 0},null),!1}catch(l){return mn.error=!0,T("re-connecting",n.transport,n),Sn++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){_(n)},n.reconnectInterval):_(n):B(0,"maxReconnectOnClose reached"),r.execCommand("Stop"),r.close(),!1}})},close:function(){o&&o(),r.execCommand("Stop"),ln(!0)}}}function z(e){null!=In?K(e):null!=vn||null!=bn?V(e):null!=wn?Y(e):null!=yn?Z(e):null!=hn?tn(e):(B(0,"No suspended connection available"),t.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function G(e,n){n||(n=nn(e)),n.transport="polling",n.method="GET",n.withCredentials=!1,n.reconnect=!1,n.force=!0,n.suspend=!1,n.timeout=1e3,P(n)}function K(e){In.send(e)}function Q(e){if(0!==e.length)try{In?In.localSend(e):dn&&dn.signal("localMessage",t.util.stringifyJSON({id:On,event:e}))}catch(n){t.util.error(n)}}function V(e){var n=nn(e);P(n)}function Y(e){if(gn.enableXDR&&t.util.checkCORSSupport()){var n=nn(e);n.reconnect=!1,S(n)}else V(e)}function Z(e){V(e)}function en(e){var n=e;return"object"==typeof n&&(n=e.data),n}function nn(e){var n=en(e),o={connected:!1,timeout:6e4,method:"POST",url:gn.url,contentType:gn.contentType,headers:gn.headers,reconnect:!0,callback:null,data:n,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:gn.withCredentials,async:gn.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:gn.enableXDR,uuid:gn.uuid,dispatchUrl:gn.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:gn.trackMessageLength,maxReconnectOnClose:gn.maxReconnectOnClose,heartbeatTimer:gn.heartbeatTimer,heartbeat:gn.heartbeat};return"object"==typeof e&&(o=t.util.extend(o,e)),o}function tn(e){var n,o=t.util.isBinary(e)?e:en(e);try{if(n=null!=gn.dispatchUrl?gn.webSocketPathDelimiter+gn.dispatchUrl+gn.webSocketPathDelimiter+o:o,!hn.canSendMessage)return void t.util.error("WebSocket not connected.");hn.send(n)}catch(r){hn.onclose=function(){},p(),M("Websocket failed. Downgrading to "+gn.fallbackTransport+" and resending "+e),V(e)}}function on(e){var n=t.util.parseJSON(e);n.id!==On&&("undefined"!=typeof gn.onLocalMessage?gn.onLocalMessage(n.event):"undefined"!=typeof t.util.onLocalMessage&&t.util.onLocalMessage(n.event))}function rn(e,n,t,o){mn.responseBody=e,mn.transport=o,mn.status=t,mn.state=n,un()}function an(e,n){if(n.readResponsesHeaders)try{var t=e.getResponseHeader("X-Atmosphere-tracking-id");t&&null!=t&&(n.uuid=t.split(" ").pop())}catch(o){}else n.enableProtocol||(n.uuid=On)}function sn(e){cn(e,gn),cn(e,t.util)}function cn(e,n){switch(e.state){case"messageReceived":l("Firing onMessage"),Sn=0,"undefined"!=typeof n.onMessage&&n.onMessage(e),"undefined"!=typeof n.onmessage&&n.onmessage(e);break;case"error":var t="undefined"!=typeof e.reasonPhrase?e.reasonPhrase:"n/a";l("Firing onError, reasonPhrase: "+t),"undefined"!=typeof n.onError&&n.onError(e),"undefined"!=typeof n.onerror&&n.onerror(e);break;case"opening":delete gn.closed,l("Firing onOpen"),"undefined"!=typeof n.onOpen&&n.onOpen(e),"undefined"!=typeof n.onopen&&n.onopen(e);break;case"messagePublished":l("Firing messagePublished"),"undefined"!=typeof n.onMessagePublished&&n.onMessagePublished(e);break;case"re-connecting":l("Firing onReconnect"),"undefined"!=typeof n.onReconnect&&n.onReconnect(gn,e);break;case"closedByClient":l("Firing closedByClient"),"undefined"!=typeof n.onClientTimeout&&n.onClientTimeout(gn);break;case"re-opening":delete gn.closed,l("Firing onReopen"),"undefined"!=typeof n.onReopen&&n.onReopen(gn,e);break;case"fail-to-reconnect":l("Firing onFailureToReconnect"),"undefined"!=typeof n.onFailureToReconnect&&n.onFailureToReconnect(gn,e);break;case"unsubscribe":case"closed":var o="undefined"!=typeof gn.closed?gn.closed:!1;o?l("Request already closed, not firing onClose ("+e.state+" case)"):(l("Firing onClose ("+e.state+" case)"),"undefined"!=typeof n.onClose&&n.onClose(e),"undefined"!=typeof n.onclose&&n.onclose(e)),gn.closed=!0;break;case"openAfterResume":"undefined"!=typeof n.onOpenAfterResume&&n.onOpenAfterResume(gn)}}function ln(e){"closed"!==mn.state&&(mn.state="closed",mn.responseBody="",mn.messages=[],mn.status=e?200:501,un())}function un(){var e=function(e,n){n(mn)};null==In&&null!=xn&&xn(mn.responseBody),gn.reconnect=gn.mrequest;for(var n="string"==typeof mn.responseBody,o=n&&gn.trackMessageLength?mn.messages.length>0?mn.messages:[""]:new Array(mn.responseBody),r=0;r<o.length;r++)if(!(o.length>1&&0===o[r].length||(mn.responseBody=n?t.util.trim(o[r]):o[r],null==In&&null!=xn&&xn(mn.responseBody),(0===mn.responseBody.length||n&&kn===mn.responseBody)&&"messageReceived"===mn.state))){if(sn(mn),a.length>0){c("debug")&&t.util.debug("Invoking "+a.length+" global callbacks: "+mn.state);try{t.util.each(a,e)}catch(i){t.util.log(gn.logLevel,["Callback exception"+i])}}if("function"==typeof gn.callback){c("debug")&&t.util.debug("Invoking request callbacks");try{gn.callback(mn)}catch(i){t.util.log(gn.logLevel,["Callback exception"+i])}}}}var dn,fn,pn,gn={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,onError:function(){},onClose:function(){},onOpen:function(){},onMessage:function(){},onReopen:function(){},onReconnect:function(){},onMessagePublished:function(){},onTransportFailure:function(){},onLocalMessage:function(){},onFailureToReconnect:function(){},onClientTimeout:function(){},onOpenAfterResume:function(){}},mn={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},hn=null,bn=null,vn=null,wn=null,yn=null,Tn=!0,Sn=0,Rn=0,kn="X",Cn=!1,xn=null,In=null,On=t.util.now();
m(e),this.subscribe=function(e){m(e),v()},this.execute=function(){v()},this.close=function(){f()},this.disconnect=function(){d()},this.getUrl=function(){return gn.url},this.push=function(e,n){if(null!=n){var t=gn.dispatchUrl;gn.dispatchUrl=n,z(e),gn.dispatchUrl=t}else z(e)},this.getUUID=function(){return gn.uuid},this.pushLocal=function(e){Q(e)},this.enableProtocol=function(){return gn.enableProtocol},this.init=function(){r()},this.request=gn,this.response=mn}},t.subscribe=function(e,n,o){"function"==typeof n&&t.addCallback(n),"string"!=typeof e?o=e:o.url=e,i="undefined"!=typeof o&&"undefined"!=typeof o.uuid?o.uuid:0;var a=new t.AtmosphereRequest(o);return a.execute(),r[r.length]=a,a},t.unsubscribe=function(){if(r.length>0)for(var e=[].concat(r),n=0;n<e.length;n++){var t=e[n];t.close(),clearTimeout(t.response.request.id),t.heartbeatTimer&&clearTimeout(t.heartbeatTimer)}r=[],a=[]},t.unsubscribeUrl=function(e){var n=-1;if(r.length>0)for(var t=0;t<r.length;t++){var o=r[t];if(o.getUrl()===e){o.close(),clearTimeout(o.response.request.id),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),n=t;break}}n>=0&&r.splice(n,1)},t.addCallback=function(e){-1===t.util.inArray(e,a)&&a.push(e)},t.removeCallback=function(e){var n=t.util.inArray(e,a);-1!==n&&a.splice(n,1)},t.util={browser:{},parseHeaders:function(e){for(var n,t=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};n=t.exec(e);)o[n[1]]=n[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,n){if(!Array.prototype.indexOf){for(var t=n.length,o=0;t>o;++o)if(n[o]===e)return o;return-1}return n.indexOf(e)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){var n=document.createElement("div");return n.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(n.firstChild.href))},prepareURL:function(e){var n=t.util.now(),o=e.replace(/([?&])_=[^&]*/,"$1_="+n);return o+(o===e?(/\?/.test(e)?"&":"?")+"_="+n:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){function n(e,n){n=t.util.isFunction(n)?n():null==n?"":n,a.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}function o(e,r){var a;if(t.util.isArray(r))t.util.each(r,function(t,r){/\[\]$/.test(e)?n(e,r):o(e+"["+("object"==typeof r?t:"")+"]",r)});else if("[object Object]"===Object.prototype.toString.call(r))for(a in r)o(e+"["+a+"]",r[a]);else n(e,r)}var r,a=[];for(r in e)o(r,e[r]);return a.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(e,n){var t;return n=n||0,function o(){t=setTimeout(function(){e()!==!1&&o()},n)}(),function(){clearTimeout(t)}},each:function(e,n,o){if(e){var r,a=0,i=e.length,s=t.util.isArray(e);if(o){if(s)for(;i>a&&(r=n.apply(e[a],o),r!==!1);a++);else for(a in e)if(r=n.apply(e[a],o),r===!1)break}else if(s)for(;i>a&&(r=n.call(e[a],a,e[a]),r!==!1);a++);else for(a in e)if(r=n.call(e[a],a,e[a]),r===!1)break;return e}},extend:function(e){var n,t,o;for(n=1;n<arguments.length;n++)if(null!=(t=arguments[n]))for(o in t)e[o]=t[o];return e},on:function(e,n,t){e.addEventListener?e.addEventListener(n,t,!1):e.attachEvent&&e.attachEvent("on"+n,t)},off:function(e,n,t){e.removeEventListener?e.removeEventListener(n,t,!1):e.detachEvent&&e.detachEvent("on"+n,t)},log:function(e,n){if(window.console){var t=window.console[e];"function"==typeof t&&t.apply(window.console,n)}},warn:function(){t.util.log("warn",arguments)},info:function(){t.util.log("info",arguments)},debug:function(){t.util.log("debug",arguments)},error:function(){t.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):new Function("return "+e)():null},stringifyJSON:function(e){function n(e){return'"'+e.replace(o,function(e){var n=r[e];return"string"==typeof n?n:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function t(e){return 10>e?"0"+e:e}var o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function a(e,o){var r,i,c,l,u=o[e],d=typeof u;switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(u=u.toJSON(e),d=typeof u),d){case"string":return n(u);case"number":return isFinite(u)?String(u):"null";case"boolean":return String(u);case"object":if(!u)return"null";switch(Object.prototype.toString.call(u)){case"[object Date]":return isFinite(u.valueOf())?'"'+u.getUTCFullYear()+"-"+t(u.getUTCMonth()+1)+"-"+t(u.getUTCDate())+"T"+t(u.getUTCHours())+":"+t(u.getUTCMinutes())+":"+t(u.getUTCSeconds())+'Z"':"null";case"[object Array]":for(c=u.length,l=[],r=0;c>r;r++)l.push(a(r,u)||"null");return"["+l.join(",")+"]";default:l=[];for(r in u)s.call(u,r)&&(i=a(r,u),i&&l.push(n(r)+":"+i));return"{"+l.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(t.util.browser.msie&&!window.XDomainRequest&&+t.util.browser.version.split(".")[0]<11)return!0;if(t.util.browser.opera&&+t.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===t.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===t.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase(),n=e.indexOf("android")>-1;return n?!0:!1}},e=t.util.now(),function(){var e=navigator.userAgent.toLowerCase(),n=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];"safari"===n[2]&&(n[2]=n[1],n[1]="safari"),t.util.browser[n[1]||""]=!0,t.util.browser.version=n[2]||"0",t.util.browser.vmajor=t.util.browser.version.split(".")[0],t.util.browser.trident&&(t.util.browser.msie=!0),(t.util.browser.msie||t.util.browser.mozilla&&1===+t.util.browser.version.split(".")[0])&&(t.util.storage=!1)}(),t.util.on(window,"unload",function(){t.util.debug(new Date+" Atmosphere: unload event"),t.unsubscribe()}),t.util.on(window,"beforeunload",function(){t.util.debug(new Date+" Atmosphere: beforeunload event"),t._beforeUnloadState=!0,setTimeout(function(){t.util.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),t._beforeUnloadState=!1},5e3)}),t.util.on(window,"keypress",function(e){(27===e.charCode||27===e.keyCode)&&e.preventDefault&&e.preventDefault()}),t.util.on(window,"offline",function(){if(t.util.debug(new Date+" Atmosphere: offline event"),o=!0,r.length>0)for(var e=[].concat(r),n=0;n<e.length;n++){var a=e[n];a.close(),clearTimeout(a.response.request.id),a.heartbeatTimer&&clearTimeout(a.heartbeatTimer)}}),t.util.on(window,"online",function(){if(t.util.debug(new Date+" Atmosphere: online event"),r.length>0)for(var e=0;e<r.length;e++)r[e].init(),r[e].execute();o=!1}),t});